---
# Stable Diffusion WebUI Forge - CUDA setup (venv-based)

- name: Ensure parent directory exists
  file:
    path: "{{ forge_install_dir | dirname }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ user_group }}"
    mode: '0755'
  tags: forge

- name: Check if Forge repository exists
  stat:
    path: "{{ forge_install_dir }}/.git"
  register: forge_repo_exists
  become_user: "{{ username }}"
  tags: forge

- name: Clone Forge repository
  git:
    repo: "{{ forge_repo_url }}"
    dest: "{{ forge_install_dir }}"
    version: "{{ forge_branch }}"
    update: yes
  become_user: "{{ username }}"
  when: not forge_repo_exists.stat.exists
  tags: forge

- name: Update Forge repository
  git:
    repo: "{{ forge_repo_url }}"
    dest: "{{ forge_install_dir }}"
    version: "{{ forge_branch }}"
    update: yes
  become_user: "{{ username }}"
  when: forge_repo_exists.stat.exists
  tags: forge

- name: Ensure Python {{ forge_python_version }} is installed
  apt:
    name:
      - python{{ forge_python_version }}
      - python{{ forge_python_version }}-venv
      - python{{ forge_python_version }}-dev
    state: present
  tags: forge

- name: Create webui-user.sh configuration file
  copy:
    dest: "{{ forge_install_dir }}/webui-user.sh"
    content: |
      #!/bin/bash
      # Forge WebUI user configuration

      # Command-line arguments
      export COMMANDLINE_ARGS="{{ forge_commandline_args }}"

      # Use Python {{ forge_python_version }}
      export python_cmd="python{{ forge_python_version }}"

      # venv directory (forge-neo creates this automatically)
      export VENV_DIR="{{ forge_install_dir }}/venv"
    owner: "{{ username }}"
    group: "{{ user_group }}"
    mode: '0755'
  tags: forge

- name: Create webui.sh launch script
  copy:
    dest: "{{ forge_install_dir }}/webui.sh"
    content: |
      #!/bin/bash
      # Forge WebUI launch script for Linux

      # Get the directory where this script is located
      SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
      cd "$SCRIPT_DIR" || exit 1

      # Load user configuration
      if [ -f webui-user.sh ]; then
          source webui-user.sh
      fi

      # Set defaults if not configured
      export COMMANDLINE_ARGS="${COMMANDLINE_ARGS:-}"
      export python_cmd="${python_cmd:-python3}"
      export VENV_DIR="${VENV_DIR:-venv}"

      # Check if venv exists, create if not
      if [ ! -d "$VENV_DIR" ]; then
          echo "Creating Python virtual environment in $VENV_DIR..."
          $python_cmd -m venv "$VENV_DIR"
          if [ $? -ne 0 ]; then
              echo "Failed to create virtual environment"
              exit 1
          fi

          # Upgrade pip
          echo "Upgrading pip..."
          "$VENV_DIR/bin/python" -m pip install --upgrade pip
      fi

      # Activate venv
      source "$VENV_DIR/bin/activate"

      # Source CUDA environment if available
      if [ -f /etc/profile.d/cuda.sh ]; then
          source /etc/profile.d/cuda.sh
      fi

      # Launch WebUI (let launch.py handle dependency installation)
      echo "Launching Forge WebUI..."
      python launch.py "$@"
    owner: "{{ username }}"
    group: "{{ user_group }}"
    mode: '0755'
  tags: forge

- name: Create model directories
  file:
    path: "{{ forge_models_dir }}/{{ item }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ user_group }}"
    mode: '0755'
  loop:
    - Stable-diffusion
    - Lora
    - VAE
    - ControlNet
    - ControlNetPreprocessor
    - ESRGAN
    - embeddings
  tags: forge

- name: Create symlinks to shared model directory
  file:
    src: "{{ shared_models_dir }}/{{ item }}"
    dest: "{{ forge_models_dir }}/{{ item }}"
    state: link
    owner: "{{ username }}"
    group: "{{ user_group }}"
  loop: "{{ shared_models_types }}"
  when: shared_models_dir is defined and shared_models_types is defined
  tags: forge

- name: Create desktop launcher (optional)
  copy:
    dest: "{{ home_dir }}/.local/share/applications/forge-neo.desktop"
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=Stable Diffusion Forge Neo
      Comment=Launch Stable Diffusion WebUI Forge with CUDA
      Exec={{ forge_install_dir }}/webui.sh
      Icon=applications-graphics
      Terminal=true
      Categories=Graphics;
    owner: "{{ username }}"
    group: "{{ user_group }}"
    mode: '0644'
  when: configure_desktop | default(true)
  tags: forge

- name: Create systemd service file (if requested)
  template:
    src: forge-neo.service.j2
    dest: /etc/systemd/system/forge-neo.service
    mode: '0644'
  when: create_forge_service | default(false)
  notify: reload systemd
  tags: forge

- name: Create Forge information file
  copy:
    dest: "{{ home_dir }}/.forge-neo-info"
    content: |
      # Stable Diffusion WebUI Forge Neo - CUDA Edition
      # Generated by Ansible on {{ ansible_date_time.iso8601 }}

      Installation Directory: {{ forge_install_dir }}
      Python Version: {{ forge_python_version }}
      Venv Directory: {{ forge_install_dir }}/venv
      Model Directory: {{ forge_models_dir }}
      {% if shared_models_dir is defined %}
      Shared Models: {{ shared_models_dir }}
      {% endif %}

      ## Quick Start

      # Launch WebUI:
      {{ forge_install_dir }}/webui.sh

      # Or navigate and launch:
      cd {{ forge_install_dir }}
      bash webui.sh

      ## Access WebUI
      http://localhost:7860

      ## Troubleshooting
      - Check NVIDIA: nvidia-smi
      - Check CUDA: nvcc --version
      - Check PyTorch (from venv):
        source {{ forge_install_dir }}/venv/bin/activate
        python -c "import torch; print(torch.cuda.is_available())"
      - See Forge documentation for more help

      ## Performance Tips
      - Command-line args: {{ forge_commandline_args }}

      ## First Launch
      The first launch will take several minutes as forge-neo:
      1. Creates the Python venv
      2. Downloads and installs PyTorch with CUDA support
      3. Installs all required dependencies
      4. Sets up the WebUI

      Subsequent launches will be much faster.
    owner: "{{ username }}"
    group: "{{ user_group }}"
    mode: '0644'
  tags: forge
