---
# Traditional pip-based package installation

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv venv
    chdir: "{{ forge_install_dir }}/app"
    creates: "{{ forge_install_dir }}/app/venv"

- name: Upgrade pip in venv
  ansible.builtin.pip:
    name:
      - pip
      - wheel
      - setuptools
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3

- name: Install PyTorch with CUDA 12.8 support
  ansible.builtin.pip:
    name:
      - torch==2.7.0
      - torchvision==0.22.0
      - torchaudio==2.7.0
      - xformers==0.0.30
    extra_args: "--index-url https://download.pytorch.org/whl/cu128"
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3

- name: Install bitsandbytes
  ansible.builtin.pip:
    name: bitsandbytes
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3

- name: Install additional ML packages and download tools
  ansible.builtin.pip:
    name:
      - svglib==1.5.1
      - hf-xet
      - huggingface-hub
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3
