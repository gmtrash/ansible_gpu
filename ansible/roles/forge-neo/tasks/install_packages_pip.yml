---
# Traditional pip-based package installation with requirements files
# Optimized for NVIDIA Blackwell GPUs (RTX 5060 Ti)

- name: Create Python 3.11 virtual environment
  ansible.builtin.command:
    cmd: python3.11 -m venv venv
    chdir: "{{ forge_install_dir }}/app"
    creates: "{{ forge_install_dir }}/app/venv"

- name: Upgrade pip in venv
  ansible.builtin.pip:
    name:
      - pip
      - wheel
      - setuptools
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3.11

- name: Copy PyTorch requirements file
  ansible.builtin.copy:
    src: forge_neo_requirements_torch_cuda128.txt
    dest: "{{ forge_install_dir }}/app/requirements_torch.txt"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Copy base requirements file
  ansible.builtin.copy:
    src: forge_neo_requirements_base.txt
    dest: "{{ forge_install_dir }}/app/requirements_base.txt"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Copy acceleration requirements file
  ansible.builtin.copy:
    src: forge_neo_requirements_acceleration_linux.txt
    dest: "{{ forge_install_dir }}/app/requirements_acceleration.txt"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Install PyTorch with CUDA 12.8 support (from requirements)
  ansible.builtin.pip:
    requirements: "{{ forge_install_dir }}/app/requirements_torch.txt"
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3.11
    extra_args: "--index-url https://download.pytorch.org/whl/cu128"

- name: Install base requirements (51+ packages)
  ansible.builtin.pip:
    requirements: "{{ forge_install_dir }}/app/requirements_base.txt"
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3.11

- name: Install acceleration packages (SageAttention for Blackwell)
  ansible.builtin.pip:
    requirements: "{{ forge_install_dir }}/app/requirements_acceleration.txt"
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3.11
    extra_args: "--no-build-isolation"

- name: Display pip installation summary
  ansible.builtin.debug:
    msg: |
      Package installation completed using pip
      Python: 3.11
      PyTorch: 2.9.0+cu128 (CUDA 12.8)
      SageAttention: 2.2.0 (Blackwell-optimized)
      Total packages: 51+ packages installed
      Virtual environment: {{ forge_install_dir }}/app/venv
