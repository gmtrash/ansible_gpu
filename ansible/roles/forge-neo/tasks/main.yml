---
- name: Wait for apt locks (in case nvidia role triggered updates)
  ansible.builtin.shell: |
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \
          fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
      echo "Waiting for apt locks..."
      sleep 2
    done
  become: yes
  changed_when: false
  timeout: 300

- name: Install system dependencies
  ansible.builtin.apt:
    name:
      - git
      - wget
      - curl
      - bzip2
      - libgl1
      - libglib2.0-0
      - libsm6
      - libxrender1
      - libxext6
      - libgomp1
      - libgoogle-perftools-dev
    state: present
    update_cache: yes
  become: yes

- name: Check if miniconda is already installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/miniconda3/bin/conda"
  register: conda_installed

- name: Download miniconda installer
  ansible.builtin.get_url:
    url: https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    dest: /tmp/miniconda-installer.sh
    mode: '0755'
  when: not conda_installed.stat.exists

- name: Install miniconda
  ansible.builtin.shell: |
    bash /tmp/miniconda-installer.sh -b -p {{ ansible_env.HOME }}/miniconda3
  when: not conda_installed.stat.exists

- name: Initialize conda for bash
  ansible.builtin.shell: |
    {{ ansible_env.HOME }}/miniconda3/bin/conda init bash
  args:
    creates: "{{ ansible_env.HOME }}/.bashrc"
  when: not conda_installed.stat.exists

- name: Install Python 3.11.9 via conda
  ansible.builtin.shell: |
    {{ ansible_env.HOME }}/miniconda3/bin/conda install -y python=3.11.9
  args:
    creates: "{{ ansible_env.HOME }}/miniconda3/bin/python3.11"
  environment:
    PATH: "{{ ansible_env.HOME }}/miniconda3/bin:{{ ansible_env.PATH }}"

- name: Create forge-neo installation directory
  ansible.builtin.file:
    path: "{{ forge_install_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Clone AUTOMATIC1111 Stable Diffusion WebUI
  ansible.builtin.git:
    repo: https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
    dest: "{{ forge_install_dir }}/app"
    version: master
    force: no

- name: Create Python virtual environment with Python 3.11 from conda
  ansible.builtin.command:
    cmd: "{{ ansible_env.HOME }}/miniconda3/bin/python3.11 -m venv venv"
    chdir: "{{ forge_install_dir }}/app"
    creates: "{{ forge_install_dir }}/app/venv"

- name: Upgrade pip in venv
  ansible.builtin.pip:
    name:
      - pip
      - wheel
      - setuptools
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: "{{ ansible_env.HOME }}/miniconda3/bin/python3.11"

- name: Install PyTorch with CUDA 12.8 support
  ansible.builtin.pip:
    name:
      - torch==2.7.0
      - torchvision==0.22.0
      - torchaudio==2.7.0
      - xformers==0.0.30
    extra_args: "--index-url https://download.pytorch.org/whl/cu128"
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: "{{ ansible_env.HOME }}/miniconda3/bin/python3.11"

- name: Install bitsandbytes
  ansible.builtin.pip:
    name: bitsandbytes
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: "{{ ansible_env.HOME }}/miniconda3/bin/python3.11"

- name: Install additional ML packages and download tools
  ansible.builtin.pip:
    name:
      - svglib==1.5.1
      - hf-xet
      - huggingface-hub
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: "{{ ansible_env.HOME }}/miniconda3/bin/python3.11"

- name: Check if webui launch script exists
  ansible.builtin.stat:
    path: "{{ forge_install_dir }}/app/webui.sh"
  register: webui_script

- name: Run initial webui setup (creates requirements and downloads models)
  ansible.builtin.shell: |
    source venv/bin/activate
    bash webui.sh -f --exit
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
  environment:
    SD_WEBUI_RESTARTING: "1"
  timeout: 1200
  when: webui_script.stat.exists
  register: webui_setup
  failed_when: false

- name: Note about first-run setup
  ansible.builtin.debug:
    msg: "Stable Diffusion WebUI will install additional requirements on first launch"
  when: not webui_script.stat.exists

- name: Copy model download helper script
  ansible.builtin.copy:
    src: download-model.sh
    dest: "{{ forge_install_dir }}/app/download-model.sh"
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Download starter model from HuggingFace (optional)
  ansible.builtin.shell: |
    source venv/bin/activate
    huggingface-cli download runwayml/stable-diffusion-v1-5 \
      --include "v1-5-pruned-emaonly.safetensors" \
      --local-dir models/Stable-diffusion/sd-v1-5 \
      --local-dir-use-symlinks False
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
    creates: "{{ forge_install_dir }}/app/models/Stable-diffusion/sd-v1-5/v1-5-pruned-emaonly.safetensors"
  when: forge_download_default_model | default(false)
  register: model_download
  ignore_errors: yes

- name: Display model download result
  ansible.builtin.debug:
    msg: "{{ 'Starter model downloaded successfully' if model_download.rc == 0 else 'Model download failed - you can download models manually later' }}"
  when: forge_download_default_model | default(false) and not model_download.skipped | default(false)

- name: Note about model downloads
  ansible.builtin.debug:
    msg: |
      Models can be downloaded using the helper script:
        cd {{ forge_install_dir }}/app
        ./download-model.sh hf runwayml/stable-diffusion-v1-5
        ./download-model.sh civitai <model-id>

      Popular models:
        HuggingFace: runwayml/stable-diffusion-v1-5
        HuggingFace: stabilityai/stable-diffusion-xl-base-1.0
        Civitai: Browse at https://civitai.com/models

      Or install the Civitai Helper extension in the WebUI

- name: Copy Forge Neo startup wrapper script
  ansible.builtin.copy:
    src: start-forge.sh
    dest: "{{ forge_install_dir }}/app/start-forge.sh"
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Create systemd service for Forge Neo
  ansible.builtin.template:
    src: forge-neo.service.j2
    dest: /etc/systemd/system/forge-neo.service
    mode: '0644'
  become: yes
  when: forge_create_service | default(true)

- name: Enable and start Forge Neo service
  ansible.builtin.systemd:
    name: forge-neo
    enabled: "{{ forge_enable_service | default(false) }}"
    state: "{{ 'started' if forge_start_service | default(false) else 'stopped' }}"
    daemon_reload: yes
  become: yes
  when: forge_create_service | default(true)

- name: Copy CUDA verification test script
  ansible.builtin.copy:
    src: test_cuda.py
    dest: "{{ forge_install_dir }}/app/test_cuda.py"
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Copy diagnostic script
  ansible.builtin.copy:
    src: diagnose-forge.sh
    dest: "{{ forge_install_dir }}/diagnose-forge.sh"
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Run CUDA verification test (with venv activated)
  ansible.builtin.shell: |
    source venv/bin/activate
    python3 test_cuda.py
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
  register: cuda_test
  failed_when: false
  changed_when: false

- name: Display CUDA verification results
  ansible.builtin.debug:
    msg: "{{ cuda_test.stdout_lines }}"
  when: cuda_test.stdout_lines is defined

- name: Display CUDA verification errors (if any)
  ansible.builtin.debug:
    msg: "{{ cuda_test.stderr_lines }}"
  when: cuda_test.stderr_lines is defined and cuda_test.stderr_lines | length > 0

- name: Fail if CUDA verification failed
  ansible.builtin.fail:
    msg: "CUDA verification failed! Please check the output above."
  when: cuda_test.rc != 0

- name: Display completion message
  ansible.builtin.debug:
    msg: |
      Stable Diffusion WebUI installation complete!

      Installation directory: {{ forge_install_dir }}/app

      To start manually:
        cd {{ forge_install_dir }}/app
        source venv/bin/activate
        bash webui.sh

      The WebUI will be available at http://{{ ansible_default_ipv4.address }}:7860

      {% if forge_create_service | default(true) %}
      Systemd service created: forge-neo.service
      Start: sudo systemctl start forge-neo
      Stop: sudo systemctl stop forge-neo
      Enable on boot: sudo systemctl enable forge-neo
      {% endif %}

      CUDA Verification: PASSED âœ“
      PyTorch with CUDA support is working correctly!

      Troubleshooting tools:
      - Diagnostic script: {{ forge_install_dir }}/diagnose-forge.sh
      - CUDA test: cd {{ forge_install_dir }}/app && source venv/bin/activate && python3 test_cuda.py
      - Service logs: sudo journalctl -u forge-neo -f
