---
- name: Wait for apt locks (in case nvidia role triggered updates)
  ansible.builtin.shell: |
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \
          fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
      echo "Waiting for apt locks..."
      sleep 2
    done
  become: yes
  changed_when: false
  timeout: 300

- name: Install system dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-venv
      - python3-dev
      - python3-pip
      - git
      - wget
      - curl
      - libgl1
      - libglib2.0-0
      - libsm6
      - libxrender1
      - libxext6
      - libgomp1
      - libgoogle-perftools-dev
    state: present
    update_cache: yes
  become: yes

- name: Create forge-neo installation directory
  ansible.builtin.file:
    path: "{{ forge_install_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Clone SD WebUI Forge Neo
  ansible.builtin.git:
    repo: https://github.com/Haoming02/sd-webui-forge-classic.git
    dest: "{{ forge_install_dir }}/app"
    version: neo
    force: no

- name: Display package manager selection
  ansible.builtin.debug:
    msg: "Using {{ 'uv (fast)' if forge_use_uv else 'pip (traditional)' }} for package installation"

- name: Install packages with uv
  ansible.builtin.include_tasks: install_packages_uv.yml
  when: forge_use_uv | bool

- name: Install packages with pip
  ansible.builtin.include_tasks: install_packages_pip.yml
  when: not (forge_use_uv | bool)

- name: Check if webui launch script exists
  ansible.builtin.stat:
    path: "{{ forge_install_dir }}/app/webui.sh"
  register: webui_script

- name: Run initial webui setup (creates requirements and downloads models)
  ansible.builtin.shell: |
    source venv/bin/activate
    bash webui.sh -f --exit
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
  environment:
    SD_WEBUI_RESTARTING: "1"
  timeout: 1200
  when: webui_script.stat.exists
  register: webui_setup
  failed_when: false

- name: Note about first-run setup
  ansible.builtin.debug:
    msg: "Forge Neo will install additional requirements on first launch"
  when: not webui_script.stat.exists

- name: Copy model download helper script
  ansible.builtin.copy:
    src: download-model.sh
    dest: "{{ forge_install_dir }}/app/download-model.sh"
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Download starter model from HuggingFace (optional)
  ansible.builtin.shell: |
    source venv/bin/activate
    huggingface-cli download runwayml/stable-diffusion-v1-5 \
      --include "v1-5-pruned-emaonly.safetensors" \
      --local-dir models/Stable-diffusion/sd-v1-5 \
      --local-dir-use-symlinks False
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
    creates: "{{ forge_install_dir }}/app/models/Stable-diffusion/sd-v1-5/v1-5-pruned-emaonly.safetensors"
  when: forge_download_default_model | default(false)
  register: model_download
  ignore_errors: yes

- name: Display model download result
  ansible.builtin.debug:
    msg: "{{ 'Starter model downloaded successfully' if model_download.rc == 0 else 'Model download failed - you can download models manually later' }}"
  when: forge_download_default_model | default(false) and not model_download.skipped | default(false)

- name: Note about model downloads
  ansible.builtin.debug:
    msg: |
      Models can be downloaded using the helper script:
        cd {{ forge_install_dir }}/app
        ./download-model.sh hf runwayml/stable-diffusion-v1-5
        ./download-model.sh civitai <model-id>

      Popular models:
        HuggingFace: runwayml/stable-diffusion-v1-5
        HuggingFace: stabilityai/stable-diffusion-xl-base-1.0
        Civitai: Browse at https://civitai.com/models

      Or install the Civitai Helper extension in the WebUI

- name: Create systemd service for Forge Neo
  ansible.builtin.template:
    src: forge-neo.service.j2
    dest: /etc/systemd/system/forge-neo.service
    mode: '0644'
  become: yes
  when: forge_create_service | default(true)

- name: Enable and start Forge Neo service
  ansible.builtin.systemd:
    name: forge-neo
    enabled: "{{ forge_enable_service | default(false) }}"
    state: "{{ 'started' if forge_start_service | default(false) else 'stopped' }}"
    daemon_reload: yes
  become: yes
  when: forge_create_service | default(true)

- name: Display completion message
  ansible.builtin.debug:
    msg: |
      Forge Neo installation complete!

      Installation directory: {{ forge_install_dir }}/app

      To start manually:
        cd {{ forge_install_dir }}/app
        source venv/bin/activate
        bash webui.sh

      The WebUI will be available at http://{{ ansible_default_ipv4.address }}:7860

      {% if forge_create_service | default(true) %}
      Systemd service created: forge-neo.service
      Start: sudo systemctl start forge-neo
      Stop: sudo systemctl stop forge-neo
      Enable on boot: sudo systemctl enable forge-neo
      {% endif %}
