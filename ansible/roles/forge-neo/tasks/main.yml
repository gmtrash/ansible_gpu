---
- name: Wait for apt locks (in case nvidia role triggered updates)
  ansible.builtin.shell: |
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \
          fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
      echo "Waiting for apt locks..."
      sleep 2
    done
  become: yes
  changed_when: false
  timeout: 300

- name: Install system dependencies
  ansible.builtin.apt:
    name:
      - git
      - wget
      - curl
      - libgl1
      - libglib2.0-0
      - libsm6
      - libxrender1
      - libxext6
      - libgomp1
      - libgoogle-perftools-dev
      - build-essential
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - libncursesw5-dev
      - xz-utils
      - tk-dev
      - libxml2-dev
      - libxmlsec1-dev
      - libffi-dev
      - liblzma-dev
    state: present
    update_cache: yes
  become: yes
  async: 300
  poll: 5

- name: Install pyenv
  ansible.builtin.git:
    repo: https://github.com/pyenv/pyenv.git
    dest: "{{ ansible_env.HOME }}/.pyenv"
    version: master
    force: no

- name: Add pyenv to shell profile
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: "{{ item }}"
    create: yes
  loop:
    - 'export PYENV_ROOT="$HOME/.pyenv"'
    - 'export PATH="$PYENV_ROOT/bin:$PATH"'
    - 'eval "$(pyenv init -)"'

- name: Install Python 3.11.9 via pyenv
  ansible.builtin.shell: |
    export PYENV_ROOT="{{ ansible_env.HOME }}/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
    pyenv install -s 3.11.9
    pyenv global 3.11.9
  args:
    creates: "{{ ansible_env.HOME }}/.pyenv/versions/3.11.9"
  environment:
    PYENV_ROOT: "{{ ansible_env.HOME }}/.pyenv"

- name: Create forge-neo installation directory
  ansible.builtin.file:
    path: "{{ forge_install_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Clone SD WebUI Forge Neo
  ansible.builtin.git:
    repo: https://github.com/Haoming02/sd-webui-forge-classic.git
    dest: "{{ forge_install_dir }}/app"
    version: neo
    force: no

- name: Create Python virtual environment with pyenv Python 3.11.9
  ansible.builtin.shell: |
    export PYENV_ROOT="{{ ansible_env.HOME }}/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
    python -m venv venv
  args:
    chdir: "{{ forge_install_dir }}/app"
    creates: "{{ forge_install_dir }}/app/venv"
  environment:
    PYENV_ROOT: "{{ ansible_env.HOME }}/.pyenv"

- name: Upgrade pip in venv
  ansible.builtin.pip:
    name:
      - pip
      - wheel
      - setuptools
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"

- name: Install PyTorch with CUDA 12.8 support
  ansible.builtin.pip:
    name:
      - torch==2.7.0
      - torchvision==0.22.0
      - torchaudio==2.7.0
      - xformers==0.0.30
    extra_args: "--index-url https://download.pytorch.org/whl/cu128"
    virtualenv: "{{ forge_install_dir }}/app/venv"

- name: Install bitsandbytes
  ansible.builtin.pip:
    name: bitsandbytes
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"

- name: Install SageAttention (2x faster than FlashAttention2)
  ansible.builtin.pip:
    name: sageattention
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"

- name: Install additional ML packages and download tools
  ansible.builtin.pip:
    name:
      - svglib==1.5.1
      - hf-xet
      - huggingface-hub
    virtualenv: "{{ forge_install_dir }}/app/venv"

- name: Check if webui launch script exists
  ansible.builtin.stat:
    path: "{{ forge_install_dir }}/app/webui.sh"
  register: webui_script

- name: Run initial webui setup (creates requirements and downloads models)
  ansible.builtin.shell: |
    source venv/bin/activate
    bash webui.sh -f --exit
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
  environment:
    SD_WEBUI_RESTARTING: "1"
  timeout: 1200
  when: webui_script.stat.exists
  register: webui_setup
  failed_when: false

- name: Note about first-run setup
  ansible.builtin.debug:
    msg: "Forge Neo will install additional requirements on first launch"
  when: not webui_script.stat.exists

- name: Copy model download helper script
  ansible.builtin.copy:
    src: download-model.sh
    dest: "{{ forge_install_dir }}/app/download-model.sh"
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Download starter model from HuggingFace (optional)
  ansible.builtin.shell: |
    source venv/bin/activate
    huggingface-cli download runwayml/stable-diffusion-v1-5 \
      --include "v1-5-pruned-emaonly.safetensors" \
      --local-dir models/Stable-diffusion/sd-v1-5 \
      --local-dir-use-symlinks False
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
    creates: "{{ forge_install_dir }}/app/models/Stable-diffusion/sd-v1-5/v1-5-pruned-emaonly.safetensors"
  when: forge_download_default_model | default(false)
  register: model_download
  ignore_errors: yes

- name: Display model download result
  ansible.builtin.debug:
    msg: "{{ 'Starter model downloaded successfully' if model_download.rc == 0 else 'Model download failed - you can download models manually later' }}"
  when: forge_download_default_model | default(false) and not model_download.skipped | default(false)

- name: Note about model downloads
  ansible.builtin.debug:
    msg: |
      Models can be downloaded using the helper script:
        cd {{ forge_install_dir }}/app
        ./download-model.sh hf runwayml/stable-diffusion-v1-5
        ./download-model.sh civitai <model-id>

      Popular models:
        HuggingFace: runwayml/stable-diffusion-v1-5
        HuggingFace: stabilityai/stable-diffusion-xl-base-1.0
        Civitai: Browse at https://civitai.com/models

      Or install the Civitai Helper extension in the WebUI

- name: Create systemd service for Forge Neo
  ansible.builtin.template:
    src: forge-neo.service.j2
    dest: /etc/systemd/system/forge-neo.service
    mode: '0644'
  become: yes
  when: forge_create_service | default(true)

- name: Enable and start Forge Neo service
  ansible.builtin.systemd:
    name: forge-neo
    enabled: "{{ forge_enable_service | default(false) }}"
    state: "{{ 'started' if forge_start_service | default(false) else 'stopped' }}"
    daemon_reload: yes
  become: yes
  when: forge_create_service | default(true)

- name: Display completion message
  ansible.builtin.debug:
    msg: |
      Forge Neo installation complete!

      Installation directory: {{ forge_install_dir }}/app

      To start manually:
        cd {{ forge_install_dir }}/app
        source venv/bin/activate
        bash webui.sh

      The WebUI will be available at http://{{ ansible_default_ipv4.address }}:7860

      {% if forge_create_service | default(true) %}
      Systemd service created: forge-neo.service
      Start: sudo systemctl start forge-neo
      Stop: sudo systemctl stop forge-neo
      Enable on boot: sudo systemctl enable forge-neo
      {% endif %}
