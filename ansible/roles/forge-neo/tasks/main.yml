---
- name: Install system dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-venv
      - python3-dev
      - python3-pip
      - git
      - wget
      - curl
      - libgl1
      - libglib2.0-0
      - libsm6
      - libxrender1
      - libxext6
      - libgomp1
      - libgoogle-perftools-dev
    state: present
    update_cache: yes
  become: yes

- name: Create forge-neo installation directory
  ansible.builtin.file:
    path: "{{ forge_install_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Clone SD WebUI Forge Neo
  ansible.builtin.git:
    repo: https://github.com/Haoming02/sd-webui-forge-classic.git
    dest: "{{ forge_install_dir }}/app"
    version: neo
    force: no

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv venv
    chdir: "{{ forge_install_dir }}/app"
    creates: "{{ forge_install_dir }}/app/venv"

- name: Upgrade pip in venv
  ansible.builtin.pip:
    name:
      - pip
      - wheel
      - setuptools
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3

- name: Install PyTorch with CUDA 12.8 support
  ansible.builtin.pip:
    name:
      - torch==2.7.0
      - torchvision==0.22.0
      - torchaudio==2.7.0
      - xformers==0.0.30
    extra_args: "--index-url https://download.pytorch.org/whl/cu128"
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3

- name: Install bitsandbytes
  ansible.builtin.pip:
    name: bitsandbytes
    state: latest
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3

- name: Install additional ML packages
  ansible.builtin.pip:
    name:
      - svglib==1.5.1
      - hf-xet
    virtualenv: "{{ forge_install_dir }}/app/venv"
    virtualenv_python: python3

- name: Check if webui launch script exists
  ansible.builtin.stat:
    path: "{{ forge_install_dir }}/app/webui.sh"
  register: webui_script

- name: Run initial webui setup (creates requirements and downloads models)
  ansible.builtin.shell: |
    source venv/bin/activate
    bash webui.sh -f --exit
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
  environment:
    SD_WEBUI_RESTARTING: "1"
  timeout: 1200
  when: webui_script.stat.exists
  register: webui_setup
  failed_when: false

- name: Note about first-run setup
  ansible.builtin.debug:
    msg: "Forge Neo will install additional requirements on first launch"
  when: not webui_script.stat.exists

- name: Note about model downloads
  ansible.builtin.debug:
    msg: "Models can be downloaded through the Forge Neo web interface at http://{{ ansible_default_ipv4.address }}:7860"

- name: Create systemd service for Forge Neo
  ansible.builtin.template:
    src: forge-neo.service.j2
    dest: /etc/systemd/system/forge-neo.service
    mode: '0644'
  become: yes
  when: forge_create_service | default(true)

- name: Enable and start Forge Neo service
  ansible.builtin.systemd:
    name: forge-neo
    enabled: "{{ forge_enable_service | default(false) }}"
    state: "{{ 'started' if forge_start_service | default(false) else 'stopped' }}"
    daemon_reload: yes
  become: yes
  when: forge_create_service | default(true)

- name: Display completion message
  ansible.builtin.debug:
    msg: |
      Forge Neo installation complete!

      Installation directory: {{ forge_install_dir }}/app

      To start manually:
        cd {{ forge_install_dir }}/app
        source venv/bin/activate
        bash webui.sh

      The WebUI will be available at http://{{ ansible_default_ipv4.address }}:7860

      {% if forge_create_service | default(true) %}
      Systemd service created: forge-neo.service
      Start: sudo systemctl start forge-neo
      Stop: sudo systemctl stop forge-neo
      Enable on boot: sudo systemctl enable forge-neo
      {% endif %}
