---
# Modern uv-based package installation with requirements files (10-100x faster)
# Optimized for NVIDIA Blackwell GPUs (RTX 5060 Ti)

- name: Set uv executable path
  ansible.builtin.set_fact:
    uv_bin: "{{ ansible_env.HOME }}/.local/bin/uv"

- name: Check if uv is installed
  ansible.builtin.stat:
    path: "{{ uv_bin }}"
  register: uv_stat

- name: Install uv (fast Python package installer)
  ansible.builtin.shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  environment:
    SHELL: /bin/bash
  when: not uv_stat.stat.exists

- name: Wait for uv binary to be available
  ansible.builtin.wait_for:
    path: "{{ uv_bin }}"
    timeout: 30
  when: not uv_stat.stat.exists

- name: Verify uv installation
  ansible.builtin.command:
    cmd: "{{ uv_bin }} --version"
  register: uv_verify
  changed_when: false

- name: Display uv version
  ansible.builtin.debug:
    msg: "uv installed: {{ uv_verify.stdout }}"

- name: Install Python 3.11 using uv
  ansible.builtin.command:
    cmd: "{{ uv_bin }} python install 3.11"
  register: uv_python_install
  changed_when: "'already installed' not in uv_python_install.stdout.lower()"
  failed_when: false

- name: Create Python 3.11 virtual environment with uv
  ansible.builtin.command:
    cmd: "{{ uv_bin }} venv venv --python 3.11"
    chdir: "{{ forge_install_dir }}/app"
    creates: "{{ forge_install_dir }}/app/venv"

- name: Copy PyTorch requirements file
  ansible.builtin.copy:
    src: forge_neo_requirements_torch_cuda128.txt
    dest: "{{ forge_install_dir }}/app/requirements_torch.txt"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Copy base requirements file
  ansible.builtin.copy:
    src: forge_neo_requirements_base.txt
    dest: "{{ forge_install_dir }}/app/requirements_base.txt"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Copy acceleration requirements file
  ansible.builtin.copy:
    src: forge_neo_requirements_acceleration_linux.txt
    dest: "{{ forge_install_dir }}/app/requirements_acceleration.txt"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Install PyTorch with CUDA 12.8 support using uv (from requirements)
  ansible.builtin.shell: |
    {{ uv_bin }} pip install \
      -r requirements_torch.txt \
      --index-url https://download.pytorch.org/whl/cu128
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
  environment:
    VIRTUAL_ENV: "{{ forge_install_dir }}/app/venv"
  register: uv_pytorch_install
  changed_when: "'Already installed' not in uv_pytorch_install.stderr"

- name: Install base requirements using uv (51+ packages)
  ansible.builtin.shell: |
    {{ uv_bin }} pip install -r requirements_base.txt
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
  environment:
    VIRTUAL_ENV: "{{ forge_install_dir }}/app/venv"
  register: uv_base_install
  changed_when: "'Already installed' not in uv_base_install.stderr"

- name: Install acceleration packages using uv (SageAttention for Blackwell)
  ansible.builtin.shell: |
    {{ uv_bin }} pip install -r requirements_acceleration.txt
  args:
    chdir: "{{ forge_install_dir }}/app"
    executable: /bin/bash
  environment:
    VIRTUAL_ENV: "{{ forge_install_dir }}/app/venv"
  register: uv_acceleration_install
  changed_when: "'Already installed' not in uv_acceleration_install.stderr"

- name: Display uv installation summary
  ansible.builtin.debug:
    msg: |
      Package installation completed using uv (10-100x faster than pip)
      Python: 3.11
      PyTorch: 2.9.0+cu128 (CUDA 12.8)
      SageAttention: 2.2.0 (Blackwell-optimized)
      Total packages: 51+ packages installed
      Virtual environment: {{ forge_install_dir }}/app/venv
      Installation time: Significantly reduced (2-3 minutes vs 15+ minutes)
