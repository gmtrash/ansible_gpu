---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Configure any pending dpkg packages
  ansible.builtin.command: dpkg --configure -a
  become: yes
  changed_when: false
  ignore_errors: yes

- name: Remove any existing NVIDIA packages
  ansible.builtin.apt:
    name:
      - 'nvidia-*'
      - 'libnvidia-*'
    state: absent
    purge: yes
    autoremove: yes
  become: yes
  ignore_errors: yes

- name: Fix broken packages if any
  ansible.builtin.command: apt-get -f install -y
  become: yes
  changed_when: false
  ignore_errors: yes

- name: Clean dpkg package database
  ansible.builtin.command: dpkg --audit
  become: yes
  changed_when: false
  ignore_errors: yes
  register: dpkg_audit

- name: Display dpkg audit results
  ansible.builtin.debug:
    var: dpkg_audit.stdout_lines
  when: dpkg_audit.stdout != ""

- name: Clean apt cache
  ansible.builtin.apt:
    autoclean: yes
    autoremove: yes
  become: yes

- name: Install required system packages
  ansible.builtin.apt:
    name:
      - build-essential
      - dkms
      - linux-headers-{{ ansible_kernel }}
      - pkg-config
      - libglvnd-dev
      - software-properties-common
      - ubuntu-drivers-common
    state: present
  become: yes

- name: Add NVIDIA driver PPA
  ansible.builtin.apt_repository:
    repo: ppa:graphics-drivers/ppa
    state: present
  become: yes

- name: Update apt cache after adding PPA
  ansible.builtin.apt:
    update_cache: yes
  become: yes

- name: Detect recommended NVIDIA driver
  ansible.builtin.shell: ubuntu-drivers devices 2>&1 | grep -v "udevadm hwdb is deprecated" | grep recommended | awk '{print $3}'
  register: nvidia_driver_version
  changed_when: false

- name: Install NVIDIA driver
  ansible.builtin.apt:
    name: "{{ nvidia_driver_version.stdout }}"
    state: present
    install_recommends: yes
    dpkg_options: 'force-confold,force-confdef'
  become: yes
  when: nvidia_driver_version.stdout != ""
  register: nvidia_install
  retries: 2
  delay: 10
  until: nvidia_install is succeeded
  ignore_errors: yes

- name: Install NVIDIA driver with force-overwrite if previous attempt failed
  ansible.builtin.shell: |
    apt-get install -y -o Dpkg::Options::="--force-overwrite" {{ nvidia_driver_version.stdout }}
  become: yes
  when:
    - nvidia_driver_version.stdout != ""
    - nvidia_install is failed
  register: nvidia_force_install

- name: Fallback to nvidia-driver-550 if detection fails
  ansible.builtin.apt:
    name: nvidia-driver-550
    state: present
    install_recommends: yes
    dpkg_options: 'force-confold,force-confdef'
  become: yes
  when: nvidia_driver_version.stdout == ""
  register: nvidia_fallback_install
  retries: 2
  delay: 10
  until: nvidia_fallback_install is succeeded
  ignore_errors: yes

- name: Fallback install with force-overwrite if needed
  ansible.builtin.shell: |
    apt-get install -y -o Dpkg::Options::="--force-overwrite" nvidia-driver-550
  become: yes
  when:
    - nvidia_driver_version.stdout == ""
    - nvidia_fallback_install is failed

- name: Install CUDA keyring
  ansible.builtin.get_url:
    url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
    dest: /tmp/cuda-keyring.deb
    mode: '0644'
  become: yes

- name: Install CUDA keyring package
  ansible.builtin.apt:
    deb: /tmp/cuda-keyring.deb
  become: yes

- name: Update apt cache for CUDA
  ansible.builtin.apt:
    update_cache: yes
  become: yes

- name: Install CUDA Toolkit 12.8
  ansible.builtin.apt:
    name:
      - cuda-toolkit-12-8
      - cuda-drivers
    state: present
  become: yes

- name: Add CUDA to PATH in profile
  ansible.builtin.lineinfile:
    path: /etc/profile.d/cuda.sh
    line: "{{ item }}"
    create: yes
    mode: '0644'
  become: yes
  loop:
    - 'export PATH=/usr/local/cuda-12.8/bin:$PATH'
    - 'export LD_LIBRARY_PATH=/usr/local/cuda-12.8/lib64:$LD_LIBRARY_PATH'

- name: Verify NVIDIA driver installation
  ansible.builtin.command: dpkg -l | grep -i nvidia-driver
  become: yes
  changed_when: false
  register: nvidia_verify
  ignore_errors: yes

- name: Display installed NVIDIA driver version
  ansible.builtin.debug:
    msg: "Installed NVIDIA driver: {{ nvidia_verify.stdout_lines }}"
  when: nvidia_verify.rc == 0

- name: Check if reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required

- name: Notify if reboot is needed
  ansible.builtin.debug:
    msg: "REBOOT REQUIRED - System needs to be rebooted for NVIDIA drivers to take effect"
  when: reboot_required.stat.exists

- name: Reboot if required (with confirmation)
  ansible.builtin.reboot:
    msg: "Rebooting to activate NVIDIA drivers"
    reboot_timeout: 300
  become: yes
  when:
    - reboot_required.stat.exists
    - nvidia_auto_reboot | default(false)
