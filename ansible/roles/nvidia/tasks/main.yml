---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Configure any pending dpkg packages
  ansible.builtin.command: dpkg --configure -a
  become: yes
  changed_when: false
  ignore_errors: yes

- name: Fix broken packages
  ansible.builtin.command: apt-get -f install -y
  become: yes
  changed_when: false
  ignore_errors: yes

- name: Check for problematic NVIDIA packages
  ansible.builtin.shell: |
    dpkg -l 2>/dev/null | grep -i nvidia | grep -v ^ii | awk '{print $2}' || echo ""
  register: broken_nvidia
  changed_when: false
  become: yes

- name: Display problematic packages
  ansible.builtin.debug:
    msg: "Found non-installed NVIDIA packages: {{ broken_nvidia.stdout_lines }}"
  when: broken_nvidia.stdout != "" and broken_nvidia.stdout_lines | length > 0

- name: Purge problematic NVIDIA packages
  ansible.builtin.apt:
    name: "{{ broken_nvidia.stdout_lines }}"
    state: absent
    purge: yes
    force: yes
  become: yes
  when: broken_nvidia.stdout != "" and broken_nvidia.stdout_lines | length > 0
  ignore_errors: yes

- name: Fix dependencies after purge
  ansible.builtin.command: apt-get -f install -y
  become: yes
  changed_when: false
  ignore_errors: yes

- name: Clean package cache
  ansible.builtin.apt:
    autoclean: yes
    autoremove: yes
  become: yes
  ignore_errors: yes

- name: Install required system packages
  ansible.builtin.apt:
    name:
      - build-essential
      - dkms
      - linux-headers-{{ ansible_kernel }}
      - pkg-config
      - libglvnd-dev
      - software-properties-common
      - ubuntu-drivers-common
    state: present
  become: yes

- name: Add NVIDIA driver PPA
  ansible.builtin.apt_repository:
    repo: ppa:graphics-drivers/ppa
    state: present
  become: yes

- name: Update apt cache after adding PPA
  ansible.builtin.apt:
    update_cache: yes
  become: yes

- name: Detect recommended NVIDIA driver
  ansible.builtin.shell: ubuntu-drivers devices 2>&1 | grep -v "udevadm hwdb is deprecated" | grep recommended | awk '{print $3}'
  register: nvidia_driver_version
  changed_when: false

- name: Display detected driver version
  ansible.builtin.debug:
    msg: "Detected NVIDIA driver: {{ nvidia_driver_version.stdout | default('None - will use fallback') }}"

- name: Install NVIDIA driver (detected version)
  ansible.builtin.apt:
    name: "{{ nvidia_driver_version.stdout }}"
    state: present
    install_recommends: yes
    dpkg_options: 'force-confold,force-confdef,force-overwrite'
  become: yes
  when: nvidia_driver_version.stdout != ""
  register: nvidia_install
  retries: 2
  delay: 10
  until: nvidia_install is succeeded
  ignore_errors: yes

- name: Display driver install error if failed
  ansible.builtin.debug:
    msg: |
      ⚠ Driver installation encountered issues:
      {{ nvidia_install.msg | default('') }}
  when: nvidia_driver_version.stdout != "" and nvidia_install.failed | default(false)

- name: Install NVIDIA driver (fallback to 550)
  ansible.builtin.apt:
    name: nvidia-driver-550
    state: present
    install_recommends: yes
    dpkg_options: 'force-confold,force-confdef,force-overwrite'
  become: yes
  when: nvidia_driver_version.stdout == "" or (nvidia_install.failed | default(false))
  register: nvidia_fallback_install
  retries: 2
  delay: 10
  until: nvidia_fallback_install is succeeded

- name: Install CUDA keyring
  ansible.builtin.get_url:
    url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
    dest: /tmp/cuda-keyring.deb
    mode: '0644'
  become: yes

- name: Install CUDA keyring package
  ansible.builtin.apt:
    deb: /tmp/cuda-keyring.deb
  become: yes

- name: Update apt cache for CUDA
  ansible.builtin.apt:
    update_cache: yes
  become: yes

- name: Install CUDA Toolkit 12.8
  ansible.builtin.apt:
    name:
      - cuda-toolkit-12-8
      - cuda-drivers
    state: present
  become: yes

- name: Add CUDA to PATH in profile
  ansible.builtin.lineinfile:
    path: /etc/profile.d/cuda.sh
    line: "{{ item }}"
    create: yes
    mode: '0644'
  become: yes
  loop:
    - 'export PATH=/usr/local/cuda-12.8/bin:$PATH'
    - 'export LD_LIBRARY_PATH=/usr/local/cuda-12.8/lib64:$LD_LIBRARY_PATH'

- name: Verify NVIDIA driver installation
  ansible.builtin.shell: dpkg -l | grep -i nvidia-driver | grep ^ii || echo "No driver installed"
  become: yes
  changed_when: false
  register: nvidia_verify

- name: Check if driver packages exist
  ansible.builtin.shell: dpkg -l | grep -i nvidia-driver | grep -q ^ii
  become: yes
  changed_when: false
  register: nvidia_check
  ignore_errors: yes

- name: Display installed NVIDIA driver version
  ansible.builtin.debug:
    msg: "✓ Installed NVIDIA driver packages: {{ nvidia_verify.stdout_lines }}"
  when: nvidia_check.rc == 0

- name: Fail if NVIDIA driver not installed
  ansible.builtin.fail:
    msg: |
      ✗ NVIDIA driver installation failed!

      Debug steps:
      1. SSH to VM: ssh {{ ansible_user }}@{{ inventory_hostname }}
      2. Run: ./check-nvidia.sh
      3. Check for errors: journalctl -xe
      4. Try manual install: sudo apt install nvidia-driver-550
  when: nvidia_check.rc != 0

- name: Check if reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required

- name: Notify if reboot is needed
  ansible.builtin.debug:
    msg: |
      ========================================
      REBOOT REQUIRED
      ========================================
      System needs to be rebooted for NVIDIA drivers to take effect.

      To reboot now: sudo reboot
      ========================================
  when: reboot_required.stat.exists

- name: Reboot if required (with confirmation)
  ansible.builtin.reboot:
    msg: "Rebooting to activate NVIDIA drivers"
    reboot_timeout: 300
  become: yes
  when:
    - reboot_required.stat.exists
    - nvidia_auto_reboot | default(false)
