---
# AMD ROCm installation and configuration

- name: Check if ROCm is already installed
  command: rocm-smi --version
  register: rocm_check
  failed_when: false
  changed_when: false
  tags: rocm

- name: Display ROCm status
  debug:
    msg: "ROCm is already installed: {{ rocm_check.stdout }}"
  when: rocm_check.rc == 0
  tags: rocm

- name: Add ROCm GPG key
  apt_key:
    url: https://repo.radeon.com/rocm/rocm.gpg.key
    state: present
  when: rocm_check.rc != 0
  tags: rocm

- name: Add ROCm repository
  apt_repository:
    repo: "deb [arch=amd64] https://repo.radeon.com/rocm/apt/{{ rocm_version }} jammy main"
    state: present
    filename: rocm
  when: rocm_check.rc != 0
  tags: rocm

- name: Update apt cache after adding ROCm repo
  apt:
    update_cache: yes
  when: rocm_check.rc != 0
  tags: rocm

- name: Install ROCm packages
  apt:
    name:
      - rocm-hip-sdk
      - rocm-smi-lib
      - rocminfo
      - rocm-dev
    state: present
  when: rocm_check.rc != 0
  tags: rocm

- name: Add ROCm binaries to PATH in /etc/environment
  lineinfile:
    path: /etc/environment
    regexp: '^PATH='
    line: 'PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/rocm/bin"'
    state: present
  tags: rocm

- name: Set ROCm environment variables in /etc/profile.d
  copy:
    dest: /etc/profile.d/rocm.sh
    content: |
      # ROCm environment variables
      export PATH="/opt/rocm/bin:$PATH"
      export ROCM_HOME=/opt/rocm
      export HIP_PATH=/opt/rocm/hip
      {% if hsa_override_gfx is defined %}
      export HSA_OVERRIDE_GFX_VERSION={{ hsa_override_gfx }}
      {% endif %}
      export HSA_ENABLE_SDMA=1
      export PYTORCH_HIP_ALLOC_CONF=expandable_segments:True
    mode: '0644'
  tags: rocm

- name: Verify ROCm installation
  command: rocm-smi --showproductname
  register: rocm_verify
  changed_when: false
  become_user: "{{ username }}"
  tags: rocm

- name: Display detected GPU
  debug:
    msg: "{{ rocm_verify.stdout_lines }}"
  tags: rocm

- name: Get GPU architecture
  shell: rocminfo | grep "Name:" | grep "gfx" | head -1 | awk '{print $2}'
  register: detected_gpu_arch
  changed_when: false
  when: gpu_architecture is not defined or gpu_architecture == ""
  tags: rocm

- name: Set GPU architecture fact
  set_fact:
    gpu_arch: "{{ gpu_architecture | default(detected_gpu_arch.stdout | default('gfx1030')) }}"
  tags: rocm

- name: Display GPU architecture
  debug:
    msg: "Using GPU architecture: {{ gpu_arch }}"
  tags: rocm

- name: Create ROCm info file for user reference
  copy:
    dest: "{{ home_dir }}/.rocm-info"
    content: |
      # ROCm Configuration
      # Generated by Ansible on {{ ansible_date_time.iso8601 }}

      ROCm Version: {{ rocm_version }}
      GPU Architecture: {{ gpu_arch }}
      {% if hsa_override_gfx is defined %}
      HSA Override: {{ hsa_override_gfx }}
      {% endif %}

      # Verify installation:
      # rocm-smi --showproductname
      # rocminfo | grep "Name:"

      # Monitor GPU:
      # watch -n 1 rocm-smi
    owner: "{{ username }}"
    group: "{{ user_group }}"
    mode: '0644'
  tags: rocm
